# Notion to News Check App データ移行ガイド

このガイドでは、NotionのデータベースからNews Check Appへのデータ移行方法を説明します。

## 前提条件

- NotionのデータベースがHTMLとしてエクスポートされていること
- 以下のプロパティが含まれていること：
  - **name**: 記事のタイトル
  - **summary**: 記事の要約
  - **created_time**: 作成日時
  - **tag**: タグ（カンマ区切りまたは単一値）
  - **URL**: 記事のURL

## セットアップ

1. **依存関係のインストール**
   ```bash
   pip install -r migration_requirements.txt
   ```

2. **HTMLファイルの準備**
   - NotionでデータベースをHTMLとしてエクスポート
   - エクスポートしたHTMLファイルをbackendディレクトリに配置

## 使用方法

### ステップ1: HTMLファイル構造の確認（推奨）

```bash
python test_html_parser.py "【ピックアップ】IT・AIニュース 3e9f1d4f446e4251be3902429dad4922.html"
```

このコマンドで、HTMLファイルの構造とデータの形式を確認できます。

### ステップ2: データ移行の実行

```bash
python notion_migration.py "【ピックアップ】IT・AIニュース 3e9f1d4f446e4251be3902429dad4922.html"
```

## スクリプトの動作

### NotionHTMLParser クラス

- HTMLファイルを解析してデータベースの内容を抽出
- テーブル構造を自動判別（`<table>` または `<div class="table">`）
- 以下のフィールドを自動マッピング：
  - **タイトル**: `name`, `タイトル`, `title`, `ニュース`
  - **URL**: `url`, `link`, `リンク`, `ソース`
  - **要約**: `summary`, `要約`, `description`, `説明`
  - **タグ**: `tag`, `tags`, `タグ`, `category`, `カテゴリー`
  - **日付**: `created_time`, `作成日`, `date`, `日付`, `created`, `timestamp`

### DatabaseMigrator クラス

- 重複チェック（タイトルベース）
- 既存の管理者ユーザーアカウントと関連付け
- トランザクション処理でデータの整合性を保証

## 対応する日付フォーマット

- `2024-01-01 12:00:00`
- `2024-01-01`
- `2024/01/01 12:00:00`
- `01/01/2024`
- `2024年1月1日`
- ISO形式（`2024-01-01T12:00:00Z`）

## エラー対応

### よくある問題

1. **ファイルが見つからない**
   ```
   ファイルが見つかりません: [ファイル名]
   ```
   → ファイルパスを確認し、ファイルがbackendディレクトリにあることを確認

2. **テーブルが見つからない**
   ```
   データベーステーブルが見つかりません
   ```
   → `test_html_parser.py`でHTML構造を確認し、必要に応じてパーサーをカスタマイズ

3. **管理者ユーザーが見つからない**
   ```
   管理者ユーザーが見つかりません
   ```
   → 先にNews Check Appでユーザーアカウントを作成

### ログ出力

スクリプト実行時に詳細なログが出力されます：
- 解析されたヘッダー情報
- データ行数
- 移行状況（成功/スキップ/エラー）

## データ確認

移行後は、News Check Appの記事一覧画面で以下を確認してください：
- 記事数が正しく移行されているか
- タイトル、要約、タグが正しく設定されているか
- 日付が適切に設定されているか

## カスタマイズ

スクリプトは以下の点でカスタマイズ可能です：

1. **フィールドマッピング**: `_map_to_article_fields` メソッドでフィールド名の対応を追加
2. **日付フォーマット**: `_parse_date` メソッドで新しい日付フォーマットに対応
3. **データクリーニング**: `_extract_cell_content` メソッドでデータの前処理を追加

## 注意事項

- 移行前に必ずデータベースのバックアップを取得してください
- 大量のデータ（1000件以上）の場合は、バッチ処理を検討してください
- 重複チェックはタイトルベースのため、同じタイトルの記事は1つだけ移行されます

## トラブルシューティング

問題が発生した場合は、以下の順序で確認してください：

1. HTMLファイルの構造確認（`test_html_parser.py`）
2. ログファイルの確認
3. データベースの管理者ユーザー存在確認
4. 必要に応じてスクリプトのデバッグ実行