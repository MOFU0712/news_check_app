# 本番サーバー検討

## 📋 概要
ITニュース管理システムの本番環境デプロイについて、ConoHa VPSとMac mini自宅サーバーの比較検討

## 🏗️ 想定構成: Option A（単一サーバー構成）

```
┌─────────────────────────────────────────────────────────┐
│                    単一サーバー                           │
├─────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌──────────────────┐  ┌─────────────┐  │
│  │   Nginx     │  │   アプリケーション  │  │ PostgreSQL  │  │
│  │ :80, :443   │─▶│ FastAPI+uvicorn │  │   :5432     │  │
│  │ (静的ファイル) │  │     :8000      │──│             │  │
│  └─────────────┘  └──────────────────┘  └─────────────┘  │
│                    ┌──────────────────┐                  │
│                    │     Redis        │                  │
│                    │     :6379        │                  │
│                    └──────────────────┘                  │
└─────────────────────────────────────────────────────────┘
```

## 🔍 Option 1: ConoHa VPS

### スペック・料金
| プラン | メモリ | CPU | SSD | 料金/月 |
|--------|--------|-----|-----|---------|
| 1GB    | 1GB    | 2Core | 100GB | 約800円 |
| 2GB    | 2GB    | 3Core | 100GB | 約1,500円 |
| 4GB    | 4GB    | 4Core | 100GB | 約3,000円 |

### メモリ使用量の予想
```
┌─────────────────────┬─────────────┐
│ サービス             │ メモリ使用量 │
├─────────────────────┼─────────────┤
│ Ubuntu OS           │ 200-300MB   │
│ PostgreSQL          │ 150-300MB   │
│ Redis               │ 50-100MB    │
│ FastAPI+uvicorn     │ 100-200MB   │
│ Nginx               │ 10-20MB     │
├─────────────────────┼─────────────┤
│ 合計                │ 510-920MB   │
└─────────────────────┴─────────────┘
```

### 1GBプラン評価: ⚠️ 条件付きで可能

#### ✅ 動作可能な条件
- 軽量化設定を適用
- スワップファイルを設定（2GB推奨）
- 同時接続数を制限
- 定期的なメモリクリア

#### ❌ 厳しい状況
- 大量スクレイピング実行時
- 複数ユーザー同時利用時
- LLM API大量使用時

### 必要な最適化設定

#### PostgreSQL軽量化
```bash
# /etc/postgresql/15/main/postgresql.conf
shared_buffers = 64MB          # デフォルト128MBから削減
work_mem = 2MB                 # デフォルト4MBから削減
maintenance_work_mem = 32MB    # デフォルト64MBから削減
max_connections = 20           # デフォルト100から削減
```

#### Redis軽量化
```bash
# /etc/redis/redis.conf
maxmemory 64mb
maxmemory-policy allkeys-lru
save ""  # バックグラウンド保存を無効化
```

#### スワップファイル作成
```bash
sudo fallocate -l 2G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile
echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
```

#### uvicorn軽量化
```bash
# 1ワーカーのみで起動
uvicorn app.main:app --host 127.0.0.1 --port 8000 --workers 1
```

### 推奨アップグレードパス
```
Phase 1: 1GB → 動作確認・テスト運用
Phase 2: 2GB → 本格運用開始（推奨）
Phase 3: 4GB → 複数ユーザー・大量データ
```

### VPSのメリット
- ✅ 月額料金が明確
- ✅ 24時間稼働
- ✅ 安定したネットワーク
- ✅ 管理・メンテナンスが簡単
- ✅ SSL証明書・ドメイン設定が容易
- ✅ スケーラブル（メモリ増設可能）

### VPSのデメリット
- ❌ 月額固定費用
- ❌ 1GBプランではリソース制約
- ❌ データ転送量制限（大量スクレイピング時）

## 🍎 Option 2: Mac mini 自宅サーバー

### スペック例（Mac mini M2）
- **CPU**: Apple M2 8コア
- **メモリ**: 8GB〜24GB（大幅に余裕）
- **ストレージ**: 256GB〜2TB SSD
- **価格**: 約10万円〜20万円（初期投資）

### Mac mini自宅サーバーのメリット
- ✅ 高性能（M2チップ）
- ✅ メモリ8GB以上で余裕のリソース
- ✅ 月額料金なし（電気代のみ）
- ✅ macOSでの開発環境との親和性
- ✅ 物理的なコントロール
- ✅ ストレージ容量が大きい

### Mac mini自宅サーバーのデメリット
- ❌ 初期投資が高額
- ❌ 自宅ネットワーク環境に依存
- ❌ 停電・回線障害のリスク
- ❌ 固定IPアドレスの確保が必要
- ❌ ドメイン・SSL設定が複雑
- ❌ セキュリティリスクが自己責任
- ❌ 外出時のメンテナンスができない

### 必要な追加設定
- **固定IP or DDNS**: MyDNS、No-IP等
- **ポート開放**: ルーター設定
- **UPS**: 無停電電源装置（推奨）
- **セキュリティ**: ファイアウォール、VPN設定

## 📊 比較表

| 項目 | ConoHa VPS (2GB) | Mac mini自宅サーバー |
|------|-------------------|---------------------|
| 初期費用 | 0円 | 10万円〜20万円 |
| 月額費用 | 1,500円 | 電気代のみ（月200-500円） |
| 年間費用 | 18,000円 | 2,400円〜6,000円（電気代） |
| 性能 | 中程度 | 高性能 |
| 安定性 | 高い | 自宅環境依存 |
| 管理の手軽さ | 簡単 | 複雑 |
| スケーラビリティ | 高い | 固定 |
| セキュリティ | プロバイダー管理 | 自己責任 |

## 💡 推奨判定

### **短期・テスト運用**: ConoHa VPS 1GB
- 費用対効果が良い
- すぐに始められる
- リスクが少ない

### **本格運用**: ConoHa VPS 2GB
- 性能と価格のバランスが良い
- 安定性が高い
- 管理が簡単

### **長期・高性能**: Mac mini自宅サーバー
- 2年以上の運用で費用回収
- 高性能で余裕のあるリソース
- 開発環境との統一性

## 🎯 段階的アプローチ（推奨）

### Phase 1: ConoHa VPS 1GBで開始
- 初期投資を抑えてテスト運用
- 実際のリソース使用量を把握
- ユーザー数・データ量を確認

### Phase 2: 必要に応じてスケールアップ
- VPS 2GBにアップグレード
- または Mac mini自宅サーバーに移行

### Phase 3: 本格運用
- データに基づいた最適な環境選択
- 長期的なコスト効率を考慮

## 📝 結論

**推奨**: まず**ConoHa VPS 1GB**で開始し、運用実績を見て**2GB**にアップグレードするのが現実的。

Mac mini自宅サーバーは魅力的だが、ネットワーク環境・セキュリティ・保守の複雑さを考慮すると、VPSの方が初期段階では適している。

---

*作成日: 2025-09-09*
*更新予定: 運用開始後、実績データに基づく見直し*